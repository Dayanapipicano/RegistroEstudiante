{%include "base.html" %}

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Obtener las tablas para arrastrar y soltar
        const porHacerTable = document.getElementById('por-hacer-table');
        const haciendoTable = document.getElementById('haciendo-table');
        
        // Configurar eventos de arrastre para filas
        document.querySelectorAll('.draggable-row').forEach((fila) => {
            fila.setAttribute('draggable', true);
            
            fila.addEventListener('dragstart', (event) => {
                event.dataTransfer.setData('text/plain', fila.getAttribute('data-id'));
            });
        });
    
        // Función para obtener el token CSRF
        function getCSRFToken() {
            let csrfToken = null;
            const cookies = document.cookie.split(';');
            cookies.forEach((cookie) => {
                const [key, value] = cookie.trim().split('=');
                if (key === 'csrftoken') {
                    csrfToken = decodeURIComponent(value);
                }
            });
            return csrfToken;
        }
    
        // Configurar el evento de soltar para cada tabla
        [porHacerTable, haciendoTable].forEach((table) => {
            table.addEventListener('dragover', (event) => {
                event.preventDefault(); // Necesario para permitir el soltar
            });
    
            table.addEventListener('drop', (event) => {
                event.preventDefault(); // Prevenir comportamientos no deseados
                const itemId = event.dataTransfer.getData('text/plain');
                const nuevoEstado = table.id === 'por-hacer-table';
    
                // Realizar la solicitud AJAX para cambiar el estado
                fetch(`/cambiar_estado/${itemId}/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCSRFToken(), // Obtener el token CSRF
                    },
                    body: JSON.stringify({ estado: nuevoEstado }),
                }).then((response) => {
                    if (response.ok) {
                        // Mover la fila a la tabla correspondiente
                        const fila = document.querySelector(`.draggable-row[data-id="${itemId}"]`);
                        table.querySelector('tbody').appendChild(fila);
                    } else {
                        console.error('Error al cambiar el estado');
                    }
                }).catch((error) => {
                    console.error('Error en la solicitud AJAX:', error);
                });
            });
        });
    });
    
    
    </script>
    

{% block body %}
<div class="container">
    <div class="row">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title">Por hacer</h5>
                </div>
                <div class="card-body">
                    <table id="por-hacer-table" class="table table-striped table-bordered">
                        <thead class="table-dark">
                            <tr>
                                <th scope="col">#</th>
                                <th scope="col">Nombre</th>
                                <th scope="col">Apellido</th>
                                <th scope="col">Correo</th>
                                <th scope="col">Edad</th>
                                <th scope="col">Estado</th>
                                <th colspan="2" scope="col">Modificación</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for c in page_obj %}
                            {% if c.estado %}
                            <tr class="draggable-row" data-id="{{ c.id }}">
                                <th scope="row">{{ forloop.counter }}</th>
                                <td>{{ c.nombre }}</td>
                                <td>{{ c.apellido }}</td>
                                <td>{{ c.correo }}</td>
                                <td>{{ c.edad }}</td>
                                <td>{{ c.estado }}</td>
                                <td><a href="{% url 'editar_estudiante' c.id %}" class="btn btn-warning btn-sm">Editar</a></td>
                                <td><a href="{% url 'eliminar_estudiante' c.id %}" class="btn btn-danger btn-sm">Eliminar</a></td>
                            </tr>
                            {% endif %}
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title">Haciendo</h5>
                </div>
                <div class="card-body">
                    <table id="haciendo-table" class="table table-striped table-bordered">
                        <thead class="table-dark">
                            <tr>
                                <th scope="col">#</th>
                                <th scope="col">Nombre</th>
                                <th scope="col">Apellido</th>
                                <th scope="col">Correo</th>
                                <th scope="col">Edad</th>
                                <th scope="col">Estado</th>
                                <th colspan="2" scope="col">Modificación</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for c in page_obj %}
                            {% if not c.estado %}
                            <tr class="draggable-row" data-id="{{ c.id }}">
                                <th scope="row">{{ forloop.counter }}</th>
                                <td>{{ c.nombre }}</td>
                                <td>{{ c.apellido }}</td>
                                <td>{{ c.correo }}</td>
                                <td>{{ c.edad }}</td>
                                <td>{{ c.estado }}</td>
                                <td><a href="{% url 'editar_estudiante' c.id %}" class="btn btn-warning btn-sm">Editar</a></td>
                                <td><a href="{% url 'activar_estudiante' c.id %}" class="btn btn-success btn-sm">Activar</a></td>
                            </tr>
                            {% endif %}
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}


    
